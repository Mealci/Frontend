name: CI

on:
  push:
    branches:
      - '**'
  pull_request:
    branches:
      - '**'

permissions:
  contents: read
  pull-requests: write

jobs:
  ci-push:
    name: VÃ©rifications CI (Push)
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3

    - name: VÃ©rifier si la CI doit Ãªtre exÃ©cutÃ©e
      id: check_run
      run: |
        PR_URL=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                 "https://api.github.com/repos/${{ github.repository }}/pulls?head=${{ github.repository_owner }}:${{ github.ref_name }}&state=open" \
                 | jq -r '.[0].url')
        if [[ $PR_URL != "null" ]]; then
          echo "skip=true" >> $GITHUB_OUTPUT
          echo "Une PR est active pour cette branche. Skipping CI pour le push."
        else
          echo "skip=false" >> $GITHUB_OUTPUT
        fi

    - name: Configuration de Flutter
      if: steps.check_run.outputs.skip != 'true'
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.2'
        channel: 'stable'
    
    - name: DÃ©sactiver les animations CLI
      if: steps.check_run.outputs.skip != 'true'
      run: flutter config --no-cli-animations
    
    - name: Obtenir les dÃ©pendances
      if: steps.check_run.outputs.skip != 'true'
      run: |
        echo -e "\e[1;34mğŸ” Obtention des dÃ©pendances...\e[0m"
        flutter pub get
        echo -e "\e[1;32mâœ… DÃ©pendances rÃ©cupÃ©rÃ©es avec succÃ¨s !\e[0m"
    
    - name: Formater le code
      if: steps.check_run.outputs.skip != 'true'
      run: |
        echo -e "\e[1;34mğŸ–Œï¸ Formatage du code...\e[0m"
        dart format --set-exit-if-changed .
        echo -e "\e[1;32mâœ… Code formatÃ© avec succÃ¨s !\e[0m"
    
    - name: ExÃ©cuter les tests
      if: steps.check_run.outputs.skip != 'true'
      run: |
        echo -e "\e[1;34mğŸ§ª ExÃ©cution des tests...\e[0m"
        flutter test
        echo -e "\e[1;32mâœ… Tests terminÃ©s avec succÃ¨s !\e[0m"
    
    - name: VÃ©rifier la porte de qualitÃ©
      if: steps.check_run.outputs.skip != 'true' && success()
      run: |
        echo -e "\e[1;32mâœ… Porte de qualitÃ© passÃ©e\e[0m"
    
    - name: Notifier l'Ã©chec
      if: steps.check_run.outputs.skip != 'true' && failure()
      run: |
        echo -e "\e[1;31mâŒ Les vÃ©rifications ont Ã©chouÃ©. Veuillez corriger les problÃ¨mes et mettre Ã  jour.\e[0m"
        exit 1

  ci-pr:
    name: VÃ©rifications CI (Pull Request)
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3

    - name: Configuration de Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.2'
        channel: 'stable'
    
    - name: DÃ©sactiver les animations CLI
      run: flutter config --no-cli-animations
    
    - name: Obtenir les dÃ©pendances
      run: |
        echo -e "\e[1;34mğŸ” Obtention des dÃ©pendances...\e[0m"
        flutter pub get
        echo -e "\e[1;32mâœ… DÃ©pendances rÃ©cupÃ©rÃ©es avec succÃ¨s !\e[0m"
    
    - name: Formater le code
      run: |
        echo -e "\e[1;34mğŸ–Œï¸ Formatage du code...\e[0m"
        dart format --set-exit-if-changed .
        echo -e "\e[1;32mâœ… Code formatÃ© avec succÃ¨s !\e[0m"
    
    - name: ExÃ©cuter les tests
      run: |
        echo -e "\e[1;34mğŸ§ª ExÃ©cution des tests...\e[0m"
        echo "place holder pour flutter test"
        # flutter test
        echo -e "\e[1;32mâœ… Tests terminÃ©s avec succÃ¨s !\e[0m"
    
    - name: Analyser le code
      id: code_analysis
      run: |
        echo -e "\e[1;34mğŸ” Analyse du code...\e[0m"
        echo "dart_output<<EOF" >> $GITHUB_OUTPUT
        dart analyze >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        echo "flutter_output<<EOF" >> $GITHUB_OUTPUT
        flutter analyze >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        echo -e "\e[1;32mâœ… Analyse du code terminÃ©e !\e[0m"
    
    - name: Commenter les rÃ©sultats de l'analyse
      uses: peter-evans/create-or-update-comment@v3
      with:
        issue-number: ${{ github.event.pull_request.number }}
        body: |
          ## RÃ©sultats de l'analyse de code
          
          ### Dart Analyze
          ```
          ${{ steps.code_analysis.outputs.dart_output }}
          ```
          
          ### Flutter Analyze
          ```
          ${{ steps.code_analysis.outputs.flutter_output }}
          ```
          
          Veuillez examiner ces rÃ©sultats et apporter les amÃ©liorations nÃ©cessaires.

    - name: ExÃ©cuter les tests d'intÃ©gration
      run: |
        echo -e "\e[1;34mğŸ§ª ExÃ©cution des tests d'intÃ©gration...\e[0m"
        echo "espace rÃ©servÃ© pour flutter drive --target=test_driver/app.dart"
        echo -e "\e[1;32mâœ… Tests d'intÃ©gration terminÃ©s avec succÃ¨s !\e[0m"
    
    - name: Analyse de sÃ©curitÃ©
      run: |
        echo -e "\e[1;34mğŸ”’ ExÃ©cution de l'analyse de sÃ©curitÃ©...\e[0m"
        echo "espace rÃ©servÃ© pour l'outil d'analyse de sÃ©curitÃ©"
        echo -e "\e[1;32mâœ… Analyse de sÃ©curitÃ© terminÃ©e !\e[0m"
    
    - name: VÃ©rifier la porte de qualitÃ©
      if: success()
      run: |
        echo -e "\e[1;32mâœ… Porte de qualitÃ© passÃ©e\e[0m"
    
    - name: Notifier l'Ã©chec
      if: failure()
      run: |
        echo -e "\e[1;31mâŒ Les vÃ©rifications ont Ã©chouÃ©. Veuillez corriger les problÃ¨mes et mettre Ã  jour.\e[0m"
        exit 1