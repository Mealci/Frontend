name: CI

on:
  push:
    branches:
      - '**'
  pull_request:
    branches:
      - '**'

jobs:
  ci:
    name: Porte de qualitÃ©
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Configuration de Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.2'
        channel: 'stable'
    
    - name: DÃ©sactiver les animations CLI
      run: flutter config --no-cli-animations
    
    - name: Obtenir les dÃ©pendances
      run: |
        echo -e "\e[1;34mğŸ” Obtention des dÃ©pendances...\e[0m"
        flutter pub get
        echo -e "\e[1;32mâœ… DÃ©pendances rÃ©cupÃ©rÃ©es avec succÃ¨s !\e[0m"
    
    - name: Formater le code
      run: |
        echo -e "\e[1;34mğŸ–Œï¸ Formatage du code...\e[0m"
        dart format --set-exit-if-changed .
        echo -e "\e[1;32mâœ… Code formatÃ© avec succÃ¨s !\e[0m"
    
    - name: ExÃ©cuter les tests
      run: |
        echo -e "\e[1;34mğŸ§ª ExÃ©cution des tests...\e[0m"
        echo "espace rÃ©servÃ© pour flutter test"
        echo -e "\e[1;32mâœ… Tests terminÃ©s avec succÃ¨s !\e[0m"
    
    - name: Analyser le code
      if: github.event_name == 'pull_request'
      run: |
        echo -e "\e[1;34mğŸ” Analyse du code...\e[0m"
        dart analyze
        echo -e "\e[1;32mâœ… Analyse du code terminÃ©e !\e[0m"
    
    - name: ExÃ©cuter Dart Code Metrics
      if: github.event_name == 'pull_request'
      run: |
        echo -e "\e[1;34mğŸ“Š ExÃ©cution de Dart Code Metrics...\e[0m"
        flutter pub add --dev dart_code_metrics
        flutter pub run dart_code_metrics:metrics analyze lib
        echo -e "\e[1;32mâœ… Analyse Dart Code Metrics terminÃ©e !\e[0m"
    
    - name: ExÃ©cuter les tests d'intÃ©gration
      if: github.event_name == 'pull_request'
      run: |
        echo -e "\e[1;34mğŸ§ª ExÃ©cution des tests d'intÃ©gration...\e[0m"
        echo "espace rÃ©servÃ© pour flutter drive --target=test_driver/app.dart"
        echo -e "\e[1;32mâœ… Tests d'intÃ©gration terminÃ©s avec succÃ¨s !\e[0m"
    
    - name: Analyse de sÃ©curitÃ©
      if: github.event_name == 'pull_request'
      run: |
        echo -e "\e[1;34mğŸ”’ ExÃ©cution de l'analyse de sÃ©curitÃ©...\e[0m"
        echo "espace rÃ©servÃ© pour l'outil d'analyse de sÃ©curitÃ©"
        echo -e "\e[1;32mâœ… Analyse de sÃ©curitÃ© terminÃ©e !\e[0m"
    
    - name: Construire les artefacts
      if: github.event_name == 'pull_request'
      run: |
        echo -e "\e[1;34mğŸ—ï¸ Construction des artefacts...\e[0m"
        flutter build apk --debug
        echo -e "\e[1;32mâœ… APK Android construit avec succÃ¨s !\e[0m"
        # DÃ©commentez la ligne suivante si vous avez un runner macOS pour la construction iOS
        # flutter build ios --debug --no-codesign
    
    - name: TÃ©lÃ©charger les artefacts
      if: github.event_name == 'pull_request'
      uses: actions/upload-artifact@v2
      with:
        name: debug-builds
        path: build/app/outputs/flutter-apk/app-debug.apk
    
    - name: VÃ©rifier la porte de qualitÃ©
      if: success()
      run: |
        echo -e "\e[1;32mâœ… Porte de qualitÃ© passÃ©e\e[0m"
    
    - name: Notifier l'Ã©chec
      if: failure()
      run: |
        echo -e "\e[1;31mâŒ Le pipeline CI a Ã©chouÃ©. Veuillez corriger les problÃ¨mes et pousser Ã  nouveau.\e[0m"
        exit 1