name: CI

on:
  push:
    branches: ['**']
  pull_request:
    branches: ['**']

permissions:
  contents: read
  pull-requests: write

jobs:
  setup:
    uses: ./.github/workflows/flutter-setup.yml

  analyze:
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Analyze code
        run: |
          flutter analyze > analysis.txt
          echo "ANALYSIS_OUTPUT<<EOF" >> $GITHUB_ENV
          cat analysis.txt >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          grep -q "No issues found!" analysis.txt && echo "ANALYSIS_ERROR=false" >> $GITHUB_ENV || echo "ANALYSIS_ERROR=true" >> $GITHUB_ENV

      - name: Comment analysis errors
        if: env.ANALYSIS_ERROR == 'true'
        uses: peter-evans/create-or-update-comment@v3
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ## ❌ Code Analysis Error
            ```
            ${{ env.ANALYSIS_OUTPUT }}
            ```

  test:
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Run tests
        run: |
          if [ -d "test" ] && [ "$(find test -name '*_test.dart' | wc -l)" -gt 0 ]; then
            flutter test || echo "TEST_ERROR=true" >> $GITHUB_ENV
          else
            echo "TEST_ERROR=false" >> $GITHUB_ENV
            echo "No tests found" >> $GITHUB_ENV
          fi

      - name: Comment test errors
        if: env.TEST_ERROR == 'true'
        uses: peter-evans/create-or-update-comment@v3
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ## ❌ Test Execution Error
            Tests failed. Please fix before merging.

  vulnerability:
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Check vulnerabilities
        run: |
          vuln_output=""
          while read pkg; do
            result=$(curl -s "https://pub.dev/api/packages/${pkg%@*}/versions/${pkg#*@}" | jq -r '.vulnerability')
            if [ "$result" != "null" ]; then
              vuln_output+="⚠️ Vulnerability in $pkg: $result\n"
            fi
          done < <(flutter pub deps --json | jq -r '.packages[] | .name + "@" + .version')
          if [ -n "$vuln_output" ]; then
            echo "VULN_ERROR=true" >> $GITHUB_ENV
            echo "VULN_OUTPUT<<EOF" >> $GITHUB_ENV
            echo "$vuln_output" >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
          else
            echo "VULN_ERROR=false" >> $GITHUB_ENV
          fi

      - name: Comment vulnerabilities
        if: env.VULN_ERROR == 'true'
        uses: peter-evans/create-or-update-comment@v3
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ## ⚠️ Vulnerabilities Detected
            ```
            ${{ env.VULN_OUTPUT }}
            ```

  success:
    needs: [analyze, test, vulnerability]
    runs-on: ubuntu-latest
    if: success()
    steps:
      - name: Comment success
        uses: peter-evans/create-or-update-comment@v3
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ## ✅ CI Passed
            All checks passed. Code is clean and ready to merge.