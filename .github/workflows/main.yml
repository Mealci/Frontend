name: CI

on:
  push:
    branches:
      - '**'
  pull_request:
    branches:
      - '**'

jobs:
  ci-base:
    name: V√©rifications de base
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Configuration de Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.2'
        channel: 'stable'
    
    - name: D√©sactiver les animations CLI
      run: flutter config --no-cli-animations
    
    - name: Obtenir les d√©pendances
      run: |
        echo -e "\e[1;34müîç Obtention des d√©pendances...\e[0m"
        flutter pub get
        echo -e "\e[1;32m‚úÖ D√©pendances r√©cup√©r√©es avec succ√®s !\e[0m"
    
    - name: Formater le code
      run: |
        echo -e "\e[1;34müñåÔ∏è Formatage du code...\e[0m"
        dart format --set-exit-if-changed .
        echo -e "\e[1;32m‚úÖ Code format√© avec succ√®s !\e[0m"
    
    - name: Ex√©cuter les tests
      run: |
        echo -e "\e[1;34müß™ Ex√©cution des tests...\e[0m"
        echo "espace r√©serv√© pour flutter test"
        echo -e "\e[1;32m‚úÖ Tests termin√©s avec succ√®s !\e[0m"
    
    - name: V√©rifier la porte de qualit√©
      if: success()
      run: |
        echo -e "\e[1;32m‚úÖ Porte de qualit√© de base pass√©e\e[0m"
    
    - name: Notifier l'√©chec
      if: failure()
      run: |
        echo -e "\e[1;31m‚ùå Les v√©rifications de base ont √©chou√©. Veuillez corriger les probl√®mes et pousser √† nouveau.\e[0m"
        exit 1

  ci-pr:
    name: V√©rifications de Pull Request
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    needs: ci-base
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Configuration de Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.2'
        channel: 'stable'
    
    - name: D√©sactiver les animations CLI
      run: flutter config --no-cli-animations
    
    - name: Obtenir les d√©pendances
      run: flutter pub get
    
    - name: Analyser le code
      run: |
        echo -e "\e[1;34müîé Analyse du code...\e[0m"
        dart analyze
        echo -e "\e[1;32m‚úÖ Analyse du code termin√©e !\e[0m"
    
    - name: Ex√©cuter Dart Code Metrics
      id: dart_code_metrics
      run: |
        echo -e "\e[1;34müìä Ex√©cution de Dart Code Metrics...\e[0m"
        flutter pub add --dev dart_code_metrics
        OUTPUT=$(flutter pub run dart_code_metrics:metrics analyze lib --reporter=console --set-exit-on-violation-level=warning)
        echo "metrics_output<<EOF" >> $GITHUB_OUTPUT
        echo "$OUTPUT" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        echo -e "\e[1;32m‚úÖ Analyse Dart Code Metrics termin√©e !\e[0m"
    
    - name: Commenter les r√©sultats de Dart Code Metrics
      uses: peter-evans/create-or-update-comment@v3
      with:
        issue-number: ${{ github.event.pull_request.number }}
        body: |
          ## R√©sultats de Dart Code Metrics
          
          ```
          ${{ steps.dart_code_metrics.outputs.metrics_output }}
          ```
          
          Veuillez examiner ces m√©triques et apporter les am√©liorations n√©cessaires.
  
    - name: Ex√©cuter les tests d'int√©gration
      run: |
        echo -e "\e[1;34müß™ Ex√©cution des tests d'int√©gration...\e[0m"
        echo "espace r√©serv√© pour flutter drive --target=test_driver/app.dart"
        echo -e "\e[1;32m‚úÖ Tests d'int√©gration termin√©s avec succ√®s !\e[0m"
    
    - name: Analyse de s√©curit√©
      run: |
        echo -e "\e[1;34müîí Ex√©cution de l'analyse de s√©curit√©...\e[0m"
        echo "espace r√©serv√© pour l'outil d'analyse de s√©curit√©"
        echo -e "\e[1;32m‚úÖ Analyse de s√©curit√© termin√©e !\e[0m"
    
    - name: V√©rifier la porte de qualit√© PR
      if: success()
      run: |
        echo -e "\e[1;32m‚úÖ Porte de qualit√© PR pass√©e\e[0m"
    
    - name: Notifier l'√©chec PR
      if: failure()
      run: |
        echo -e "\e[1;31m‚ùå Les v√©rifications de PR ont √©chou√©. Veuillez corriger les probl√®mes et mettre √† jour la pull request.\e[0m"
        exit 1